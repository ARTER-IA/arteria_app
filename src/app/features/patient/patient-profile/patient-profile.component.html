<form [formGroup]="patientFormGroup">
    <div class="flex justify-content-center align-items-center h-full">
        <p-card [style]="{ width: '360' }">
            <div class="flex flex-column md:flex-row md:px-5">
                <!-- Primera Columna -->
                <div class="w-full md:w-3 flex flex-column row-gap-3">
                    <!-- Dentro de la primera columna, en el bloque de la foto de perfil -->
                    <div class="flex flex-wrap justify-content-center text-center">
                        <p-image *ngIf="profilePictureUrl" [src]="profilePictureUrl" alt="Profile Picture"
                            width="250"></p-image>
                    </div>
                    <div *ngIf="isEditing" class="flex flex-wrap justify-content-center text-center mt-3">
                        <p-fileUpload mode="basic" chooseLabel="Browse" [auto]="true" name="pictureProfileUri"
                            customUpload="true" (uploadHandler)="onUpload($event)" accept="image/jpeg"
                            maxFileSize="1000000" />
                    </div>

                    <h2>Información Personal</h2>
                    <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                        <label for="firstName">Nombres</label>
                        <input type="text" pInputText id="firstName" class="w-full" formControlName="firstName" />
                        <small *ngIf="patientFormGroup.get('firstName')?.invalid && (patientFormGroup.get('firstName')?.dirty ||
                                      patientFormGroup.get('firstName')?.touched)" class="block p-error">
                            <div *ngIf="patientFormGroup.get('firstName')?.errors?.['required']">
                                Nombre es requerido
                            </div>
                            <div *ngIf="patientFormGroup.get('firstName')?.errors?.['pattern']">
                                Ingresa un nombre válido
                            </div>
                        </small>

                    </div>
                    <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                        <label for="lastName">Apellidos</label>
                        <input type="text" pInputText id="lastName" class="w-full" formControlName="lastName" />
                        <small *ngIf="patientFormGroup.get('lastName')?.invalid && (patientFormGroup.get('lastName')?.dirty ||
                                      patientFormGroup.get('lastName')?.touched)" class="block p-error">
                            <div *ngIf="patientFormGroup.get('lastName')?.errors?.['required']">
                                Apellido es requerido
                            </div>
                            <div *ngIf="patientFormGroup.get('lastName')?.errors?.['pattern']">
                                Ingresa un apellido válido
                            </div>
                        </small>
                    </div>
                    <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                        <label for="birthdayDate">Fecha de nacimiento</label>
                        <p-calendar [showIcon]="true" class="w-full" formControlName="birthdayDate"
                            [showOnFocus]="false"></p-calendar>
                        <small *ngIf="patientFormGroup.get('birthdayDate')?.invalid && (patientFormGroup.get('birthdayDate')?.dirty ||
                            patientFormGroup.get('birthdayDate')?.touched)" class="block p-error">
                            <div *ngIf="patientFormGroup.get('birthdayDate')?.errors?.['required']">
                                Fecha de nacimiento es requerido
                            </div>
                        </small>
                    </div>
                    <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                        <label for="gender">Género</label>
                        <p-dropdown formControlName="gender" [options]="genders" optionLabel="name" id="gender"
                            name="gender" class="w-full" />
                    </div>
                    <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                        <label for="dni">DNI</label>
                        <input type="dni" pInputText id="dni" class="w-full" formControlName="dni" />
                        <small *ngIf="patientFormGroup.get('dni')?.invalid && (patientFormGroup.get('dni')?.dirty || 
                            patientFormGroup.get('dni')?.touched)" class="block p-error">
                            <div *ngIf="patientFormGroup.get('dni')?.errors?.['required']">
                                DNI es requerido
                            </div>
                            <div *ngIf="patientFormGroup.get('dni')?.errors?.['pattern']">
                                Ingrese un DNI válido
                            </div>
                        </small>
                    </div>
                    <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                        <label for="phoneNumber">Celular</label>
                        <input type="text" pInputText id="phoneNumber" class="w-full" formControlName="phoneNumber" />
                        <small *ngIf="patientFormGroup.get('phoneNumber')?.invalid && (patientFormGroup.get('phoneNumber')?.dirty || 
                            patientFormGroup.get('phoneNumber')?.touched)" class="block p-error">
                            <div *ngIf="patientFormGroup.get('phoneNumber')?.errors?.['required']">
                                Celular es requerido
                            </div>
                            <div *ngIf="patientFormGroup.get('phoneNumber')?.errors?.['pattern']">
                                Ingrese un Celular válido
                            </div>
                        </small>
                    </div>
                    <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                        <label for="email">Correo</label>
                        <input type="text" pInputText id="email" class="w-full" formControlName="email" />
                        <small *ngIf="patientFormGroup.get('email')?.invalid && (patientFormGroup.get('email')?.dirty || 
                            patientFormGroup.get('email')?.touched)" class="block p-error">
                            <div *ngIf="patientFormGroup.get('email')?.errors?.['required']">
                                Correo es requerido
                            </div>
                            <div *ngIf="patientFormGroup.get('email')?.errors?.['email']">
                                Ingrese un correo válido
                            </div>
                        </small>
                    </div>
                </div>

                <div class="w-full md:w-1">
                    <p-divider layout="vertical" styleClass="hidden md:flex">
                        <b> </b>
                    </p-divider>
                    <p-divider layout="horizontal" styleClass="flex md:hidden" [align]="'center'">
                        <b> </b>
                    </p-divider>
                </div>

                <!-- Segunda Columna -->
                <div class="w-full md:w-8 flex flex-column gap-3">
                    <div class="flex flex-column md:flex-row gap-4">
                        <div class="w-full md:w-6 flex flex-column row-gap-3">
                            <h2>Información Médica Básica</h2>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="height">Altura (cm)</label>
                                <input type="number" pInputText id="height" class="w-full" formControlName="height" />
                                <small *ngIf="patientFormGroup.get('height')?.invalid && (patientFormGroup.get('height')?.dirty ||
                                    patientFormGroup.get('height')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('height')?.errors?.['required']">
                                        Altura es requerido
                                    </div>
                                </small>
                            </div>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="weight">Peso (kg)</label>
                                <input type="number" pInputText id="weight" class="w-full" formControlName="weight" />
                                <small *ngIf="patientFormGroup.get('weight')?.invalid && (patientFormGroup.get('weight')?.dirty ||
                                    patientFormGroup.get('weight')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('weight')?.errors?.['required']">
                                        Peso es requerido
                                    </div>
                                </small>
                            </div>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="bloodGroup">Grupo sanguíneo</label>
                                <input type="text" pInputText id="bloodGroup" class="w-full"
                                    formControlName="bloodGroup" />
                                <small *ngIf="patientFormGroup.get('bloodGroup')?.invalid && (patientFormGroup.get('bloodGroup')?.dirty ||
                                    patientFormGroup.get('bloodGroup')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('bloodGroup')?.errors?.['required']">
                                        Grupo sanguíneo es requerido
                                    </div>
                                </small>
                            </div>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="allergies">Alergias</label>
                                <input type="text" pInputText id="allergies" class="w-full" formControlName="allergies" />
                                <small *ngIf="patientFormGroup.get('allergies')?.invalid && (patientFormGroup.get('allergies')?.dirty ||
                                    patientFormGroup.get('allergies')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('allergies')?.errors?.['required']">
                                        Alergias es requerido
                                    </div>
                                </small>
                            </div>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="currentMedications">Medicación actual</label>
                                <input type="text" pInputText id="currentMedications" class="w-full" formControlName="currentMedications" />
                                <small *ngIf="patientFormGroup.get('currentMedications')?.invalid && (patientFormGroup.get('currentMedications')?.dirty ||
                                    patientFormGroup.get('currentMedications')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('currentMedications')?.errors?.['required']">
                                        Medicación actual es requerido
                                    </div>
                                </small>
                            </div>

                            <h2>Información sobre el Seguro Médico</h2>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="insuranceNumber">Número del seguro</label>
                                <input type="text" pInputText id="insuranceNumber" class="w-full" formControlName="insuranceNumber" />
                                <small *ngIf="patientFormGroup.get('insuranceNumber')?.invalid && (patientFormGroup.get('insuranceNumber')?.dirty ||
                                    patientFormGroup.get('insuranceNumber')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('insuranceNumber')?.errors?.['required']">
                                        Número del seguro es requerido
                                    </div>
                                </small>
                            </div>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="policy">Poliza</label>
                                <input type="text" pInputText id="policy" class="w-full" formControlName="policy" />
                                <small *ngIf="patientFormGroup.get('policy')?.invalid && (patientFormGroup.get('policy')?.dirty ||
                                    patientFormGroup.get('policy')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('policy')?.errors?.['required']">
                                        Poliza del seguro es requerido
                                    </div>
                                </small>
                            </div>
                        </div>

                        <div class="w-full md:w-1">
                            <p-divider layout="vertical" styleClass="hidden md:flex">
                                <b> </b>
                            </p-divider>
                            <p-divider layout="horizontal" styleClass="flex md:hidden" [align]="'center'">
                                <b> </b>
                            </p-divider>
                        </div>

                        <div class="w-full md:w-6 flex flex-column gap-3">
                            <h2>Historial Médico</h2>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="previousIllnesses">Enfermedades previas</label>
                                <input type="text" pInputText id="previousIllnesses" class="w-full" formControlName="previousIllnesses" />
                                <small *ngIf="patientFormGroup.get('previousIllnesses')?.invalid && (patientFormGroup.get('previousIllnesses')?.dirty ||
                                    patientFormGroup.get('previousIllnesses')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('previousIllnesses')?.errors?.['required']">
                                        Enfermedades previas es requerido
                                    </div>
                                </small>
                            </div>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="previousSurgeries">Cirugías previas</label>
                                <input type="text" pInputText id="previousSurgeries" class="w-full" formControlName="previousSurgeries" />
                                <small *ngIf="patientFormGroup.get('previousSurgeries')?.invalid && (patientFormGroup.get('previousSurgeries')?.dirty ||
                                    patientFormGroup.get('previousSurgeries')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('previousSurgeries')?.errors?.['required']">
                                        Cirugías previas es requerido
                                    </div>
                                </small>
                            </div>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="currentConditions">Condiciones actuales</label>
                                <p-chips formControlName="currentConditions" id="currentConditions" name="currentConditions" />
                                <small *ngIf="patientFormGroup.get('currentConditions')?.invalid && (patientFormGroup.get('currentConditions')?.dirty ||
                                    patientFormGroup.get('currentConditions')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('currentConditions')?.errors?.['required']">
                                        Condiciones actuales es requerido
                                    </div>
                                </small>
                            </div>

                            <h2>Contacto de Emergencia</h2>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="emergencyContact">Nombre completo</label>
                                <input type="text" pInputText id="emergencyContact" class="w-full" formControlName="emergencyContact" />
                                <small *ngIf="patientFormGroup.get('emergencyContact')?.invalid && (patientFormGroup.get('emergencyContact')?.dirty ||
                                    patientFormGroup.get('emergencyContact')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('emergencyContact')?.errors?.['required']">
                                        Nombre de contacto es requerido
                                    </div>
                                </small>
                            </div>
                            <div class="flex flex-wrap justify-content-start align-items-start gap-2">
                                <label for="emergencyPhoneNumber">Celular</label>
                                <input type="text" pInputText id="emergencyPhoneNumber" class="w-full" formControlName="emergencyPhoneNumber" />
                                <small *ngIf="patientFormGroup.get('emergencyPhoneNumber')?.invalid && (patientFormGroup.get('emergencyPhoneNumber')?.dirty ||
                                    patientFormGroup.get('emergencyPhoneNumber')?.touched)" class="block p-error">
                                    <div *ngIf="patientFormGroup.get('emergencyPhoneNumber')?.errors?.['required']">
                                        Número de celular de contacto es requerido
                                    </div>
                                    <div *ngIf="patientFormGroup.get('emergencyPhoneNumber')?.errors?.['pattern']">
                                        Ingrese un número de celular de contacto válido
                                    </div>
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="w-full flex flex-column gap-3">
                        <h2>Últimos Resultados</h2>
                        <div *ngIf="results && results.length > 0; else noResults">
                            <p-listbox [options]="results" formControlName="selectedResult" optionLabel="id"
                                [style]="{ width: '100%', 'background-color': '#EAE9F5' }"
                                (onChange)="onSelectResult($event)">
                                <ng-template let-result pTemplate="item">
                                    <div class="flex gap-8">
                                        <p>Fecha: {{ result.createdAt | date:'short' }}</p>
                                        <p>Resultado obtenido: {{ result.predictionProbability }}</p>
                                    </div>
                                </ng-template>
                            </p-listbox>
                        </div>
                        <ng-template #noResults>
                            <p-card
                                [style]="{ 'background-color': '#EAE9F5', 'box-shadow': 'none', 'border': '1px solid #DBDBDE' }">
                                <div class="flex flex-wrap md:justify-content-between justify-content-center">
                                    <p>Parece que este paciente aún no tiene resultados.</p>
                                    <p-button label="Ir a predicción de EAC" (click)="goToCADPrediction()"
                                        icon="pi pi-check"></p-button>
                                </div>
                            </p-card>
                        </ng-template>
                    </div>

                    <div class="flex flex-wrap justify-content-center align-items-center">
                        <p-button *ngIf="!isEditing" (click)="onEditProfile()" label="Editar perfil" icon="pi pi-pencil"
                            styleClass="w-10rem mx-auto"></p-button>
                        <p-button *ngIf="isEditing" (click)="onSaveChanges()" label="Guardar" icon="pi pi-save"
                            [disabled]="patientFormGroup.invalid" styleClass="w-12rem mx-auto"></p-button>
                    </div>
                </div>
            </div>
        </p-card>
    </div>
</form>